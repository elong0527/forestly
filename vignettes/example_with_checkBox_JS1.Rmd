---
title: "Example with Checkbox with JS"
output: 
  html_document:
    self_contained: false
vignette: >
  %\VignetteIndexEntry{Example with Checkbox with JS}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE, 
  warning = FALSE
)
```

This vignette introduces the construction of interactive forest plot. 
We will generate several reactables with checkboxes as Adverse Events (AE) filters. 
For example, for `AESER`, there are two checkboxes with `Y` for serious AE and `N` for non-serious AE.
In this vignette, the AE Structure including 

- Source of Organ (SOC): `adae$AESOC`
- Serious AE: `adae$AESER`
- Drug related AE: `adae$AEREL`
- AE result in death: `adae$AEOUT`

# 1. Load Required Package 
```{r setup}
library(DescTools)      # Compare risk difference (Obtain confidence interval)
library(plotly)         # Interactive figure 
library(reactable)      # Interactive table 
library(dplyr)          
library(tidyr)
library(crosstalk)
library(htmltools)
devtools::load_all()
```


# 2. Data Prepartion

## 2.1 Read data
```{r}
head(adsl)
head(adae)
```

## 2.2 Define analysis data
```{r}
# tidy_ae_table is defined in R/ folder with same name 
# obtain AE information ready for visualization
db_aeser <- tidy_ae_table1(population_from  = adsl %>% rename(TRTA = TRT01A), 
                     observation_from = adae,
                     population_where = NULL, 
                     observation_where = NULL,
                     treatment_var = "TRTA",  #sometimes it is "ACTLARM",
                     treatment_order = c("MK9999" = "Xanomeline High Dose", "Placebo" = "Placebo"),
                     ae_var = "AEDECOD",
                     ae_interested = "AESER",
                     listing_var = c("SITEID", "USUBJID", "RACE", "SEX", 
                                     "AETERM", "AESER", "AEREL", "AEACN", "AEOUT") )

db_aerel <- tidy_ae_table1(population_from  = adsl %>% rename(TRTA = TRT01A), 
                     observation_from = adae,
                     population_where = NULL, 
                     observation_where = NULL,
                     treatment_var = "TRTA",  #sometimes it is "ACTLARM",
                     treatment_order = c("MK9999" = "Xanomeline High Dose", "Placebo" = "Placebo"),
                     ae_var = "AEDECOD",
                     ae_interested = "AEREL",
                     listing_var = c("SITEID", "USUBJID", "RACE", "SEX", 
                                     "AETERM", "AESER", "AEREL", "AEACN", "AEOUT") )


# db <- tidy_ae_table(population_from  = adsl %>% rename(TRTA = TRT01A),
#                     observation_from = adae,
#                     treatment_var = "TRTA",
#                     treatment_order = c("MK9999" = "Xanomeline High Dose", "Placebo" = "Placebo"),
#                     listing_var = c("SITEID", "USUBJID", "AGE", "RACE", "SEX", 
#                                     "AETERM", "AESER", "AEREL", "AEACN", "AEOUT") )
```

## 2.3 Calculate propotion test using M&N method
```{r}
# Calculate test using M&N method 
tb_aeser <- cbind(db_aeser$table,
            with(db_aeser$table, prop_test_mn(x0 = n_2, n0 = N_2, x1 = n_1, n1 = N_1))) 
tb_aerel <- cbind(db_aerel$table,
            with(db_aerel$table, prop_test_mn(x0 = n_2, n0 = N_2, x1 = n_1, n1 = N_1))) 

t_display_aeser <- tb_aeser %>% mutate(fig_prop = NA, fig_diff = est, 
                           ae = tools::toTitleCase(tolower(ae))) %>% 
                    select(ae, ae_substructure, stratum, 
                           fig_prop, fig_diff, n_1, pct_1, n_2, pct_2)
t_display_aerel <- tb_aerel %>% mutate(fig_prop = NA, fig_diff = est, 
                           ae = tools::toTitleCase(tolower(ae))) %>% 
                    select(ae, ae_substructure, stratum, 
                           fig_prop, fig_diff, n_1, pct_1, n_2, pct_2)
```

## 2.4 Contruct the table containg all the details
```{r}
# Listing of subjects
# Require proper format for the header. 
t_detail_aeser <- db_aeser$listing
t_detail_aerel <- db_aerel$listing
```

## 2.5 Set the color of the two propotion in the forest plot
```{r}
color <- c("gold", "purple")
```

# 3. Construct Interactive Froest Plot

## 3.1 Define auxilliary functions for the interactive plot
```{r}
# function to create proportion of subjects figure

js_fig_prop_cell_aeser <- sparkline_point_js(tbl = tb_aeser,
                                       x = c("pct_1","pct_2"),
                                       y = c(1, 1),
                                       xlim = round(range(c(tb_aeser$pct_1, tb_aeser$pct_2)) + c(-0.51, 0.51) ),
                                       color = color,
                                       height = 30)

js_fig_prop_cell_aerel <- sparkline_point_js(tbl = tb_aerel,
                                       x = c("pct_1","pct_2"),
                                       y = c(1, 1),
                                       xlim = round(range(c(tb_aerel$pct_1, tb_aerel$pct_2)) + c(-0.51, 0.51) ),
                                       color = color,
                                       height = 30)
# fig_prop_cell <- function(value, index){
# 
#   tmp <- tb[index, ] %>% pivot_longer(cols = starts_with("pct"))
#   xlim <- round(range(c(tb$pct_1, tb$pct_2)) + c(-0.51, 0.51) )
# 
#   sparkline_point(x = tmp$value,
#                   y = tmp$ae,
#                   xlim = xlim,
#                   color = color,
#                   height = 30)
# }

# function to create Axis 
fig_prop_footer_aeser <- function(value){
  
  tmp <- tb_aeser[1, ] %>% pivot_longer(cols = starts_with("pct"))
  xlim <- round(range(c(tb_aeser$pct_1, tb_aeser$pct_2)) + c(-0.51, 0.51) )
  sparkline_draw_axis(color = color, 
                      label = levels(db_aeser$listing$treatment), 
                      xlim = xlim)
}

fig_prop_footer_aerel <- function(value){
  
  tmp <- tb_aerel[1, ] %>% pivot_longer(cols = starts_with("pct"))
  xlim <- round(range(c(tb_aerel$pct_1, tb_aerel$pct_2)) + c(-0.51, 0.51) )
  sparkline_draw_axis(color = color, 
                      label = levels(db_aerel$listing$treatment), 
                      xlim = xlim)
}

# function to create proportion difference figure
fig_diff_cell_aeser <- function(value, index){
  
  tmp <- tb_aeser[index, ] 
  xlim = round(range(c(tb_aeser$lower, tb_aeser$upper)) + c(-0.51, 0.51))
  
  sparkline_errorbar(tmp$est, 
                     tmp$lower, 
                     tmp$upper, 
                     xlim = xlim, 
                     color = "black")
}

fig_diff_cell_aerel <- function(value, index){
  
  tmp <- tb_aerel[index, ] 
  xlim = round(range(c(tb_aerel$lower, tb_aerel$upper)) + c(-0.51, 0.51))
  
  sparkline_errorbar(tmp$est, 
                     tmp$lower, 
                     tmp$upper, 
                     xlim = xlim, 
                     color = "black")
}

# function to create Axis 
fig_diff_footer_aeser <- function(value){
  
  tmp <- tb_aeser[1, ] %>% pivot_longer(cols = starts_with("pct"))
  xlim = round(range(c(tb_aeser$lower, tb_aeser$upper)) + c(-0.51, 0.51))
  sparkline_draw_axis(showlegend = FALSE, 
                      xlab = "MK9999 <- Favor -> Placebo", 
                      color = "black",
                      xlim = xlim, height = 60, margin_bottom = 50)
}

fig_diff_footer_aerel <- function(value){
  
  tmp <- tb_aerel[1, ] %>% pivot_longer(cols = starts_with("pct"))
  xlim = round(range(c(tb_aerel$lower, tb_aerel$upper)) + c(-0.51, 0.51))
  sparkline_draw_axis(showlegend = FALSE, 
                      xlab = "MK9999 <- Favor -> Placebo", 
                      color = "black",
                      xlim = xlim, height = 60, margin_bottom = 50)
}

# function to create check box
filter_checkbox_nobs <- function(id, label, sharedData, group, allLevels = FALSE, inline = FALSE, columns = 1) {
  options <- crosstalk:::makeGroupOptions(sharedData, group, allLevels)
  labels <- options$items$label
  values <- options$items$value
  options$items <- NULL
  makeCheckbox <- if (inline) {
    crosstalk:::inlineCheckbox
  } else {
    crosstalk:::blockCheckbox
  }
  htmltools::browsable(attachDependencies(
    tags$div(
      id = id,
      class = "form-group crosstalk-input-checkboxgroup crosstalk-input",
      tags$label(
        class = "control-label", `for` = id,
        style = "font-weight: 600;",
        label
      ), tags$div(
        class = "crosstalk-options-group",
        crosstalk:::columnize(
          columns,
          mapply(labels, values, FUN = function(label, value) {
            makeCheckbox(id, value, label)
          }, SIMPLIFY = FALSE, USE.NAMES = FALSE)
        )
      ), tags$script(
        type = "application/json",
        `data-for` = id,
        jsonlite::toJSON(options, dataframe = "columns", pretty = TRUE)
      )
    ),
    c(list(crosstalk:::jqueryLib()), crosstalkLibs())
  ))
}
```

## 3.2 Make the data frame eligible for check box design
```{r}
t_display1_aeser <- SharedData$new(t_display_aeser)
t_display1_aerel <- SharedData$new(t_display_aerel)
```


## 3.3 Plot the interative forest plot
```{r, message=FALSE}
h3("Filter by:")

tagList(
  filter_checkbox_nobs("filter_AEcategory", "Serious Events", t_display1_aeser, ~ae_substructure, inline = TRUE),
  br()
)

# mk_reactable saved in the R/ folder: define default behavior of reactable. 
p_aeser <- mk_reactable(
  t_display1_aeser,
  
  # reactable configuration https://glin.github.io/reactable/reference/reactable.html
  resizable = TRUE, 
  filterable = TRUE,
  searchable = TRUE, 
  defaultPageSize = 10, 
  borderless = TRUE, 
  striped = TRUE, 
  highlight = TRUE, 
  
  # No padding between two cells (ensure no break line between reference line)
  theme = reactableTheme(cellPadding = "0px 8px"),
  
  # Default sort variable 
  defaultSorted = c("fig_diff"),
  
  # Define listing of subjects
  details = function(index){
    t_row <- t_display_aeser[index, ]
    subset(t_detail_aeser, toupper(ae) %in% toupper(t_row$ae)) %>% mk_reactable
  },
  
  # Customize cell feature 
  columnGroups = list(
    colGroup(name = "MK9999 (N = 84)",  columns = c("n_1", "pct_1")),
    colGroup(name = "Placebo (N = 86)", columns = c("n_2", "pct_2"))
  ),
  # 
  column = list(
    ae = colDef(header = "Adverse Events", minWidth = 300, align = "right"),

    stratum = colDef(header = "Stratum", show = FALSE),

    fig_prop = colDef(header = "AE Proportion (%)",
                      minWidth = 300, align = "center",
                      cell = JS(js_fig_prop_cell_aeser), 
                      #cell = fig_prop_cell, 
                      footer = fig_prop_footer_aeser,
                      html = TRUE
    ),


    fig_diff = colDef(header = "Risk Diff (%) + 95% CI",
                      defaultSortOrder = "desc",
                      minWidth = 200, align = "center",
                      cell = fig_diff_cell_aeser, footer = fig_diff_footer_aeser,
                      show = TRUE),

    n_1 = colDef(header = "n", defaultSortOrder = "desc", width = 60, align = "center"),
    n_2 = colDef(header = "n", defaultSortOrder = "desc", width = 60, align = "center"),
    pct_1 = colDef(header = "(%)", defaultSortOrder = "desc", width = 80, align = "center", format = colFormat(digits = 2) ),
    pct_2 = colDef(header = "(%)", defaultSortOrder = "desc", width = 80, align = "center", format = colFormat(digits = 2) )
  )

)

plotly_js <- "https://unpkg.com/react-plotly.js@1.0.2/dist/create-plotly-component.js"
browsable(tagList(
  reactR::html_dependency_react(),
  htmltools::tags$script(src="https://cdn.plot.ly/plotly-latest.min.js"),
  htmltools::tags$script(src=plotly_js),
  p_aeser
))
```

```{r, message=FALSE}
h3("Filter by:")

tagList(
  filter_checkbox_nobs("filter_AEcategory", "Drug related AE", t_display1_aerel, ~ae_substructure, inline = TRUE),
  br()
)

# mk_reactable saved in the R/ folder: define default behavior of reactable. 
p_aerel <- mk_reactable(
  t_display1_aerel,
  
  # reactable configuration https://glin.github.io/reactable/reference/reactable.html
  resizable = TRUE, 
  filterable = TRUE,
  searchable = TRUE, 
  defaultPageSize = 10, 
  borderless = TRUE, 
  striped = TRUE, 
  highlight = TRUE, 
  
  # No padding between two cells (ensure no break line between reference line)
  theme = reactableTheme(cellPadding = "0px 8px"),
  
  # Default sort variable 
  defaultSorted = c("fig_diff"),
  
  # Define listing of subjects
  details = function(index){
    t_row <- t_display_aerel[index, ]
    subset(t_detail_aerel, toupper(ae) %in% toupper(t_row$ae)) %>% mk_reactable
  },
  
  # Customize cell feature 
  columnGroups = list(
    colGroup(name = "MK9999 (N = 84)",  columns = c("n_1", "pct_1")),
    colGroup(name = "Placebo (N = 86)", columns = c("n_2", "pct_2"))
  ),
  # 
  column = list(
    ae = colDef(header = "Adverse Events", minWidth = 300, align = "right"),

    stratum = colDef(header = "Stratum", show = FALSE),

    fig_prop = colDef(header = "AE Proportion (%)",
                      minWidth = 300, align = "center",
                      cell = JS(js_fig_prop_cell_aerel), 
                      #cell = fig_prop_cell, 
                      footer = fig_prop_footer_aerel,
                      html = TRUE
    ),


    fig_diff = colDef(header = "Risk Diff (%) + 95% CI",
                      defaultSortOrder = "desc",
                      minWidth = 200, align = "center",
                      cell = fig_diff_cell_aerel, footer = fig_diff_footer_aerel,
                      show = TRUE),

    n_1 = colDef(header = "n", defaultSortOrder = "desc", width = 60, align = "center"),
    n_2 = colDef(header = "n", defaultSortOrder = "desc", width = 60, align = "center"),
    pct_1 = colDef(header = "(%)", defaultSortOrder = "desc", width = 80, align = "center", format = colFormat(digits = 2) ),
    pct_2 = colDef(header = "(%)", defaultSortOrder = "desc", width = 80, align = "center", format = colFormat(digits = 2) )
  )

)

plotly_js <- "https://unpkg.com/react-plotly.js@1.0.2/dist/create-plotly-component.js"
browsable(tagList(
  reactR::html_dependency_react(),
  htmltools::tags$script(src="https://cdn.plot.ly/plotly-latest.min.js"),
  htmltools::tags$script(src=plotly_js),
  p_aerel
))
```
